{% extends "two_factor/_base.html" %}

{% load i18n %}
{% load django_bootstrap_breadcrumbs %}
{% load common_tags %}

{% block title %}{% trans "Login" %}{% endblock %}

{% block breadcrumbs %}
    {{ block.super }}
    {% breadcrumb 'Account' None %}
    {% breadcrumb 'Login' None %}
{% endblock %}

{% block content %}
    <h1>
        {% trans "Login" %}

        {% if wizard.steps.current == 'auth' %}
            <small>
                {% blocktrans trimmed %}
                    Enter your credentials.
                {% endblocktrans %}
            </small>
        {% elif wizard.steps.current == 'token' %}
            <small>
                {% blocktrans trimmed %}
                    AstroBin needs an additional step to verify your login. Please enter the token generated by your
                    token generator or received via email.
                {% endblocktrans %}

                <a href="https://welcome.astrobin.com/features/security/#faq" target="_blank">
                    {% trans "Learn more." %}
                </a>
            </small>
        {% elif wizard.steps.current == 'backup' %}
            <small>
                {% blocktrans trimmed %}
                    Use this form for entering backup tokens for logging in. These tokens have been generated for you to
                    print and keep safe. Please enter one of these backup tokens to login to your account.
                {% endblocktrans %}
            </small>
        {% endif %}
    </h1>

    <form action="" method="post" class="form-horizontal login-form" novalidate>{% csrf_token %}

        {% if wizard.steps.current == 'token' %}
            <div class="control-group">
                <div class="controls">
                    {% pop_session_value 'enforce_otp_middleware_invalid_password' as is_invalid_password %}
                    {% pop_session_value 'enforce_otp_middleware_new_country' as is_new_country %}

                    {% if is_invalid_password %}
                        <div class="alert alert-warning">
                            <p>
                                {% blocktrans trimmed %}
                                    AstroBin detected that your password does not meet security requirements
                                {% endblocktrans %}.

                                {% blocktrans trimmed %}
                                    To make sure that this is a legitimate login attempt, we just sent you a one-time
                                    password token via e-mail.
                                {% endblocktrans %}

                                <a href="https://welcome.astrobin.com/features/security/#faq" target="_blank">
                                    {% trans "Learn more." %}
                                </a>
                            </p>
                        </div>
                    {% endif %}

                    {% if is_new_country %}
                        <div class="alert alert-warning">
                            <p>
                                {% blocktrans trimmed %}
                                    AstroBin detected a login attempt from a different country
                                {% endblocktrans %}.

                                {% blocktrans trimmed %}
                                    To make sure that this is a legitimate login attempt, we just sent you a one-time
                                    password token via e-mail.
                                {% endblocktrans %}

                                <a href="https://welcome.astrobin.com/features/security/#faq" target="_blank">
                                    {% trans "Learn more." %}
                                </a>
                            </p>
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endif %}

        {% include "two_factor/_wizard_forms.html" %}

        {# hidden submit button to enable [enter] key #}
        <input type="submit" value="" class="hidden" />

        {% if backup_tokens %}
            <p>{% trans "As a last resort, you can use a backup token:" %}</p>
            <p>
                <button
                    name="wizard_goto_step"
                    type="submit"
                    value="backup"
                    class="btn btn-secondary btn-mobile-block">
                    {% trans "Use backup token" %}
                </button>
            </p>
        {% endif %}

        {% include "two_factor/_wizard_actions.html" %}
    </form>
{% endblock %}
