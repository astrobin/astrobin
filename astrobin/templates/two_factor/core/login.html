{% extends "two_factor/_base.html" %}

{% load i18n %}
{% load django_bootstrap_breadcrumbs %}
{% load common_tags %}

{% block title %}{% trans "Login" %}{% endblock %}

{% block breadcrumbs %}
    {{ block.super }}
    {% breadcrumb 'Account' None %}
    {% breadcrumb 'Login' None %}
{% endblock %}

{% block content %}
    {% pop_session_value 'enforce_otp_middleware_user_email' as user_email %}

    <h1>
        {% trans "Login" %}

        {% if wizard.steps.current == 'auth' %}
            <small>
                {% blocktrans trimmed %}
                    Enter your credentials.
                {% endblocktrans %}
            </small>
        {% elif wizard.steps.current == 'token' %}
            {% pop_session_value 'enforce_otp_middleware_email_device' as has_email_device %}
            {% pop_session_value 'enforce_otp_middleware_totp_device' as has_totp_device %}

            <small>
                {% blocktrans trimmed %}
                    AstroBin needs an additional step to verify your login.
                {% endblocktrans %}

                {% if has_email_device or has_totp_device %}
                    <p class="alert alert-info">
                        {% if has_email_device %}
                            {% blocktrans trimmed %}
                                We just sent you an email with a one-time password token to the address
                                <strong>{{ user_email }}</strong>. Please enter it below.
                            {% endblocktrans %}
                        {% elif has_totp_device %}
                            {% blocktrans trimmed %}
                                Please enter the token generated by your token generator app or device (usually this is Google
                                Authenticator or similar).
                            {% endblocktrans %}
                        {% endif %}

                        <a href="https://welcome.astrobin.com/features/security/#faq" target="_blank">
                            {% trans "Learn more." %}
                        </a>
                    </p>
                {% endif %}
            </small>
        {% elif wizard.steps.current == 'backup' %}
            <small>
                {% blocktrans trimmed %}
                    Use this form for entering backup tokens for logging in. These tokens have been generated for you to
                    print and keep safe. Please enter one of these backup tokens to login to your account.
                {% endblocktrans %}
            </small>
        {% endif %}
    </h1>

    <form action="" method="post" class="form-horizontal login-form" novalidate>{% csrf_token %}

        {% if wizard.steps.current == 'token' %}
            <div class="control-group">
                <div class="controls">
                    {% pop_session_value 'enforce_otp_middleware_invalid_password' as is_invalid_password %}
                    {% pop_session_value 'enforce_otp_middleware_new_country' as is_new_country %}

                    {% if is_invalid_password %}
                        <div class="alert alert-warning">
                            <p>
                                {% blocktrans trimmed %}
                                    AstroBin detected that your password does not meet security requirements
                                {% endblocktrans %}.

                                {% blocktrans trimmed %}
                                    To make sure that this is a legitimate login attempt, we just sent you a one-time
                                    password token via e-mail.
                                {% endblocktrans %}

                                <a href="https://welcome.astrobin.com/features/security/#faq" target="_blank">
                                    {% trans "Learn more." %}
                                </a>
                            </p>
                        </div>
                    {% elif is_new_country %}
                        <div class="alert alert-warning">
                            <p>
                                {% blocktrans trimmed %}
                                    AstroBin detected a login attempt from a different country
                                {% endblocktrans %}.

                                {% blocktrans trimmed %}
                                    To make sure that this is a legitimate login attempt, we just sent you a one-time
                                    password token via e-mail to the address <strong>{{ user_email }}</strong>.
                                {% endblocktrans %}

                                <a href="https://welcome.astrobin.com/features/security/#faq" target="_blank">
                                    {% trans "Learn more." %}
                                </a>
                            </p>
                        </div>
                    {% else %}
                        <div class="alert alert-warning">
                            <p>
                                <strong>
                                    {% blocktrans trimmed %}
                                        Don't want this next time?
                                    {% endblocktrans %}
                                </strong>

                                {% blocktrans trimmed %}
                                    Remember that you can disable two-factor authentication in your settings after
                                    logging in.
                                {% endblocktrans %}
                            </p>
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endif %}

        {% include "two_factor/_wizard_forms.html" %}

        {# hidden submit button to enable [enter] key #}
        <input type="submit" value="" class="hidden" />

        {% if backup_tokens %}
            <p>{% trans "As a last resort, you can use a backup token:" %}</p>
            <p>
                <button
                    name="wizard_goto_step"
                    type="submit"
                    value="backup"
                    class="btn btn-secondary btn-mobile-block">
                    {% trans "Use backup token" %}
                </button>
            </p>
        {% endif %}

        {% include "two_factor/_wizard_actions.html" %}
    </form>
{% endblock %}
