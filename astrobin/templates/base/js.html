{% load i18n %}
{% load static %}
{% load cache %}
{% load astrobin_apps_premium_tags %}
{% load common_tags %}

<!-- javascript -->
<script type="text/javascript">
    $(window).bind('beforeunload', function() {
        $.each(astrobin_common.globals.requests, function(i, xhr) {
            try {
                xhr.abort();
            } catch(e) {
                if (console)
                    console.log('failed to abort xhr');
            }
        });
        astrobin_common.globals.requests = [];
    });

    function getInternetExplorerVersion()
    // Returns the version of Internet Explorer or a -1
    // (indicating the use of another browser).
    {
      var rv = -1; // Return value assumes failure.
      if (navigator.appName == 'Microsoft Internet Explorer')
      {
        var ua = navigator.userAgent;
        var re  = new RegExp("MSIE ([0-9]{1,}[\.0-9]{0,})");
        if (re.exec(ua) != null)
          rv = parseFloat( RegExp.$1 );
      }
      return rv;
    }

    {% if request.user.is_authenticated %}
        {% cache 600 hotjar_identify user.id request.LANGUAGE_CODE %}
            function initHotjarIdentify() {
                if (window.hj !== undefined) {
                    var userId = "{{ request.user.id }}";

                    window.hj("identify", userId, {
                        "Registration date": new Date("{{ request.user.date_joined|date:"Y-m-d" }}").toISOString(),
                        "Language": "{{ request.LANGUAGE_CODE }}",
                        "Country": "{{ REQUEST_COUNTRY }}",
                        "Images": {{ request.user.image_set.count }},
                        "Is Free": "{{ request.user|is_free }}" === "True",
                        "Is Lite": "{{ request.user|is_any_lite }}" === "True",
                        "Is Premium": "{{ request.user|is_any_premium }}" === "True",
                        "Is Ultimate": "{{ request.user|is_any_ultimate }}" === "True",

                    });
                } else {
                    setTimeout(function() {
                        initHotjarIdentify();
                    }, 500);
                }
            }
        {% endcache %}

        initHotjarIdentify();
    {% endif %}

    var dictionary = {
        'Cancel': '{% trans "Cancel" %}'
    };
    $.i18n.setDictionary(dictionary);

    $.localise('ui-multiselect', {
        loadBase: false,
        language: '{{request.LANGUAGE_CODE|default:'en'}}',
        path: '{% get_static_prefix %}' + 'astrobin/js/locale/',
        timeout: 500
    });


    $(document).ready(function() {
        astrobin_common.init({
            is_authenticated: {{ request.user.is_authenticated|yesno:"true,false" }},
            open_notifications_in_new_tab: {{ request.user.userprofile.open_notifications_in_new_tab|yesno:"true,false" }}
        });

        astrobin_common.setup_user_popovers();

        $('input:checkbox, input:radio, input:file').uniform(
            {fileDefaultText: '{% trans "No file selected" %}',
             fileBtnText: '{% trans "Choose file" %}'
            }
        );

        {% trans "Like" context 'Verb (imperative)' as i18nLike %}
        {% trans "Unlike" context 'Verb (imperative)' as i18nUnlike %}
        {% trans "Browse images currently visible on the page." as i18nFancyboxHelp %}

        Fancybox.bind("[data-fancybox]", {
            infinite: false,
            autoFocus: false,
            i10n: {
                CLOSE: "{{ _("Close") | escapejs }}",
                NEXT: "{{ _("Next") | escapejs }}",
                PREV: "{{ _("Previous") | escapejs }}",
                MODAL: "{{ _("You can close this modal content with the ESC key") | escapejs }}",
                ERROR: "{{ _("Something went wrong, Please try again later.") | escapejs }}",
                IMAGE_ERROR: "{{ _("Image not found") | escapejs }}",
                ELEMENT_NOT_FOUND: "{{ _("HTML Element not found") | escapejs }}",
                AJAX_NOT_FOUND: "{{ _("Error loading AJAX : Not Found") | escapejs }}",
                AJAX_FORBIDDEN: "{{ _("Error loading AJAX : Forbidden") | escapejs }}",
                IFRAME_ERROR: "{{ _("Error loading page") | escapejs }}",
            },
            on: {
                initCarousel: (fancybox) => {
                    const slide = fancybox.Carousel.slides[fancybox.Carousel.page];

                    fancybox.$container.style.setProperty(
                        "--bg-image",
                        `url("${slide.src}")`
                    );
                },
                "Carousel.change": (fancybox, carousel, to, from) => {
                    const slide = carousel.slides[to];

                    fancybox.$container.style.setProperty(
                        "--bg-image",
                        `url("${slide.src}")`
                    );
                },
            },
            caption: function (fancybox, carousel, slide) {
                const $element = $(slide.$trigger);
                const $img = $element.closest('figure').find('.astrobin-image');
                const userId = $img.data('user-id');
                const imageId = $img.data('id');
                const imageIdOrHash = $img.data('id-or-hash');


                let likeButton = '';

                {% if request.user.is_authenticated %}
                    if ($element.data('fancybox') === 'image-list' && {{ request.user.id }} !== userId) {
                        likeButton = `
                            <a
                                href="#"
                                class="btn btn-primary toggleproperty-button {% button_loading_class %} running"
                                disabled="disabled"
                            >
                                {{ i18nLike | escapejs }}
                                {% button_loading_indicator %}
                            </a>
                        `;
                    }

                    setTimeout(function () {
                        if ($element.data('fancybox') === 'image-list' && {{ request.user.id }} !== userId) {
                            $.ajax({
                                type: 'get',
                                url: '/api/v2/common/contenttypes/?app_label=astrobin&model=image',
                                dataType: 'json',
                                success: (contentTypeResponse) => {
                                    const contentType = contentTypeResponse[0];

                                    $.ajax({
                                        type: 'get',
                                        url: `/api/v2/common/toggleproperties?content_type=${contentType.id}&property_type=like&user_id={{ request.user.pk }}&object_id=${imageId}`,
                                        dataType: 'json',
                                        success: (togglepropertyResponse) => {
                                            const liked = togglepropertyResponse.count > 0;

                                            const likeButtonLabel = liked ? '{{ i18nUnlike | escapejs }}' : '{{ i18nLike | escapejs }}';

                                            const $likeButton = $(`
                                                <a
                                                    href="#"
                                                    class="btn btn-${liked ? 'secondary' : 'primary'} toggleproperty-button {% button_loading_class %}"
                                                    data-content-type="${contentType.id}"
                                                    data-object-id=${imageId}"
                                                    data-liked="${liked}"
                                                >
                                                    ${likeButtonLabel}
                                                    {% button_loading_indicator %}
                                                </a>
                                            `);

                                            $likeButton.click(function (e) {
                                                e.preventDefault();

                                                const self = this;

                                                $(self).addClass('running');
                                                if ($(self).data("liked")) {
                                                    $.ajax({
                                                        type: 'delete',
                                                        url: `/api/v2/common/toggleproperties/${togglepropertyResponse.results[0].pk}`,
                                                        timeout: 5000,
                                                        success: function (response) {
                                                            $(self)
                                                                .removeClass('running btn-secondary')
                                                                .addClass('btn-primary')
                                                                .data("liked", false)
                                                                .html('{{ i18nLike | escapejs }} {% button_loading_indicator %}');
                                                        },
                                                        error: function (XMLHttpRequest, textStatus, errorThrown) {
                                                            $('#cant-unlike').modal('show');
                                                            $(self).removeClass('running');
                                                        }
                                                    });
                                                } else {
                                                    $.ajax({
                                                        type: 'post',
                                                        url: '/api/v2/common/toggleproperties/',
                                                        data: {
                                                            property_type: 'like',
                                                            content_type: contentType.id,
                                                            object_id: imageId,
                                                            user: {{ request.user.id }}
                                                        },
                                                        timeout: 5000,
                                                        success: function (response) {
                                                            togglepropertyResponse = {
                                                                results: [
                                                                    response
                                                                ]
                                                            };

                                                            $(self)
                                                                .removeClass('running btn-primary')
                                                                .addClass('btn-secondary')
                                                                .data("liked", true)
                                                                .html('{{ i18nUnlike | escapejs }} {% button_loading_indicator %}');
                                                        },
                                                        error: function (XMLHttpRequest, textStatus, errorThrown) {
                                                            if (XMLHttpRequest.status === 401) {
                                                                window.location.href = `/accounts/login/?next=/${imageIdOrHash}`;
                                                                return;
                                                            } else {
                                                                $('#cant-like').modal('show');
                                                            }

                                                            $(self).removeClass('running');
                                                        }
                                                    });
                                                }
                                            })

                                            $('.fancybox__caption__buttons').find('.toggleproperty-button').remove();
                                            $('.fancybox__caption__buttons').append($likeButton);
                                        }
                                    })
                                }
                            })
                        }
                    }, 250);
                {% endif %} {# authenticated #}

                return `
                    <div class="fancybox__caption__text">${$element.data("caption")}</div>
                    <div class="fancybox__caption__buttons">
                        <a href="${$element.data('url')}" class="btn btn-primary view-page-button">
                            {% trans 'View page' %}
                        </a>
                        <a href="${$element.data('url-hd')}" class="btn btn-secondary view-large-button">
                            {% trans 'View large' %}
                        </a>
                        ${likeButton}
                    </div>
                    <div class="fancybox__caption__help">
                        {{ i18nFancyboxHelp | escapejs }}
                    </div>
                `;
            },
            Thumbs: {
                Carousel: {
                    fill: false,
                    center: true,
                },
            },
        });

        $('.astrobin-thumbnail .astrobin-image-container figcaption').each(function () {
            if (!window.bowser) {
                return;
            }

            const browserParser = window.bowser.getParser(window.navigator.userAgent);

            if (!browserParser) {
                return;
            }

            const os = browserParser.getOS();

            if (os.name === 'iOS') {
                $(this)
                    .css('display', 'none')
                    .find('.image-slideshow-button').remove();
            }
        });

        $("form:not(.ajax) [type='submit']").one("click", function (event) {
            var $target = $(event.target);
            var $form = $target.closest("form");

            $form.find(":submit").addClass("running");

            // Have a timeout to make sure the browser shows the spinning indicator.
            window.setTimeout(function() {
                $target.trigger(event.type);
                $(":submit").prop("disabled", true);
            }, 10);

            event.preventDefault();
            return false;
        });

        $(".shadow-ban").click(function () {
            var userPk = $(this).data('user-pk');
            $("#shadow-ban-modal #userPk").val(userPk);
        });

        $(".remove-shadow-ban").click(function () {
            var userPk = $(this).data('user-pk');
            $("#remove-shadow-ban-modal #userPk").val(userPk);
        });
    });
</script>

