{% extends 'base.html' %}
{% load i18n %}
{% load bootstrap_toolkit %}
{% load django_bootstrap_breadcrumbs %}
{% load tags %}
{% load staticfiles %}

{% block title %}AstroBin - {% blocktrans with user=user %}{{user}}'s commercial products{% endblocktrans %}{% endblock %}
{% block container_extra_classes %}has-subnav{% endblock %}

{% block breadcrumbs %}
    {{ block.super }}
    {% breadcrumb_safe 'Users' None %}
    {% breadcrumb request.user.userprofile.get_display_name 'user_page' request.user.username %}
    {% breadcrumb 'Commercial products' None %}
{% endblock %}

{% block content %}
    {% include 'user/profile/navigation.html' %}

    {% if READONLY_MODE %}
        {% include 'readonly_mode.html' %}
    {% else %}
        {% if user == request.user %}
        <div class="alert alert-info">
            <i class="icon-info-sign"></i>
            {% blocktrans %}Please remember that you are only allowed to claim items that you really produce and/or retail.{% endblocktrans %}
        </div>
        {% endif %}

        {% if user_is_producer %}
            <div class="row section">
                <div class="span12">
                    <div class="subtle-container">
                        {% if user_is_retailer %}
                            <div class="header">
                                <h4>{% trans "As producer" %}</h4>
                            </div>
                        {% endif %}
                        <table class="table commercial-gear-items">
                            <tr>
                                <th>{% trans "Gear IDs" %}</th>
                                <th>{% trans "Make" %}</th>
                                <th>{% trans "Name" %}</th>
                                <th>{% trans "Owners" %}</th>
                                <th>{% trans "Images" %}</th>
                                {% ifequal user request.user %}
                                    <th>{% trans "Actions" %}</th>
                                {% endifequal %}
                            </tr>
                            {% for item in commercial_gear_list %}
                                <tr data-id="{{item.id}}">
                                    <td class="gear-ids" data-gear-ids="{% for g in item.base_gear.all %}{{g.id}}{% if not forloop.last %},{% endif %}{% endfor %}">
                                        {% for g in item.base_gear.all %}
                                            <a rel="popover" class="gear-popover"
                                               data-load="{% url 'gear_popover_ajax' g.id %}"
                                               href="{% url 'gear_page' g.id g.slug %}">
                                                {{g.id}}
                                            </a>{% if not forloop.last %}, {% endif %}
                                        {% endfor %}
                                    </td>
                                    <td>
                                        {% if item.proper_make %}
                                            {{item.proper_make}}
                                        {% else %}
                                            {{item.base_gear.all.0.make}}
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.proper_name %}
                                            {{item.proper_name}}
                                        {% else %}
                                            {{item.base_gear.all.0.name}}
                                        {% endif %}
                                    </td>
                                    <td>{% gear_set_owners item.base_gear %}</td>
                                    <td>{% gear_set_images item.base_gear %}</td>

                                    {% ifequal user request.user %}
                                    <td>
                                        <a rel="tooltip" title="{% trans "View" %}" href="{% url 'gear_page' item.base_gear.all.0.id item.base_gear.all.0.slug %}">
                                            <i class="icon-eye-open"></i>
                                        </a>
                                        <a rel="tooltip" title="{% trans "Edit" %}" href="{% url 'commercial_products_edit' item.id %}">
                                            <i class="icon-edit"></i>
                                        </a>
                                        <a class="item-merge" rel="tooltip" title="{% trans "Merge" %}" href="#">
                                            <i class="icon-resize-small"></i>
                                        </a>
                                        <a class="item-remove" rel="tooltip" title="{% trans "Remove" %}" href="#">
                                            <i class="icon-remove"></i>
                                        </a>
                                    </td>
                                    {% endifequal %}
                                </tr>
                            {% empty %}
                                <tr class="empty">
                                    <td colspan="6">
                                        {% ifequal user request.user %}
                                            {% trans "You haven't claimed any commercial products yet." %}
                                        {% else %}
                                            {% blocktrans with user as user %}{{user}} hasn't claimed any commercial products yet.{% endblocktrans %}
                                        {% endifequal %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </table>
                    </div>
                </div>
            </div>
        {% endif %} <!-- user_is_producer -->

        {% if user_is_retailer %}
            <div class="row section">
                <div class="span12">
                    <div class="subtle-container">
                        {% if user_is_producer %}
                            <div class="header">
                                <h4>{% trans "As retailer" %}</h4>
                            </div>
                        {% endif %}
                        <table class="table retailed-gear-items">
                            <tr>
                                <th>{% trans "Gear IDs" %}</th>
                                <th>{% trans "Make" %}</th>
                                <th>{% trans "Name" %}</th>
                                <th>{% trans "Owners" %}</th>
                                <th>{% trans "Images" %}</th>
                                {% ifequal user request.user %}
                                    <th>{% trans "Actions" %}</th>
                                {% endifequal %}
                            </tr>
                            {% for item in retailed_gear_list %}
                                <tr data-id="{{item.id}}">
                                    <td class="gear-ids" data-gear-ids="{% for g in item.base_gear.all %}{{g.id}}{% if not forloop.last %},{% endif %}{% endfor %}">
                                        {% for g in item.base_gear.all %}
                                            <a rel="popover" class="gear-popover"
                                               data-load="{% url 'gear_popover_ajax' g.id %}"
                                               href="{% url 'gear_page' g.id g.slug %}">
                                                {{g.id}}
                                            </a>{% if not forloop.last %}, {% endif %}
                                        {% endfor %}
                                    </td>
                                    <td>
                                        {% if item.proper_make %}
                                            {{item.proper_make}}
                                        {% else %}
                                            {{item.base_gear.all.0.make}}
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.proper_name %}
                                            {{item.proper_name}}
                                        {% else %}
                                            {{item.base_gear.all.0.name}}
                                        {% endif %}
                                    </td>
                                    <td>{% gear_set_owners item.base_gear %}</td>
                                    <td>{% gear_set_images item.base_gear %}</td>

                                    {% ifequal user request.user %}
                                    <td>
                                        <a rel="tooltip" title="{% trans "View" %}" href="{% url 'gear_page' item.base_gear.all.0.id item.base_gear.all.0.slug %}">
                                            <i class="icon-eye-open"></i>
                                        </a>
                                        <a rel="tooltip" title="{% trans "Edit" %}" href="{% url 'retailed_products_edit' item.id %}">
                                            <i class="icon-edit"></i>
                                        </a>
                                        <a class="retailed-item-merge" rel="tooltip" title="{% trans "Merge" %}" href="#">
                                            <i class="icon-resize-small"></i>
                                        </a>
                                        <a class="retailed-item-remove" rel="tooltip" title="{% trans "Remove" %}" href="#">
                                            <i class="icon-remove"></i>
                                        </a>
                                    </td>
                                    {% endifequal %}
                                </tr>
                            {% empty %}
                                <tr class="empty">
                                    <td colspan="6">
                                        {% ifequal user request.user %}
                                            {% trans "You haven't claimed any retailed products yet." %}
                                        {% else %}
                                            {% blocktrans with user as user %}{{user}} hasn't claimed any retailed products yet.{% endblocktrans %}
                                        {% endifequal %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </table>
                    </div>
                </div>
            </div>
        {% endif %} <!-- user_is_retailer -->

        {% if user == request.user and user_is_producer or user_is_retailer %}
            <div class="row section">
                <div class="span12" style="text-align: center">
                    {% if user_is_producer %}
                    <a href="#claim-commercial-product-modal"
                       class="btn btn-primary claim-commercial-product"
                       data-toggle="modal">{% trans "Claim as producer" %}</a>
                    {% endif %}

                    {% if user_is_retailer %}
                        <a href="#claim-retailed-product-modal"
                           class="btn btn-primary claim-retailed-product"
                           data-toggle="modal">{% trans "Claim as retailer" %}</a>
                    {% endif %}
                </div>
            </div>
        {% endif %}
    {% endif %} {# READONLY_MODE #}
{% endblock %}

{% ifequal user request.user %}
    {% block modals %}
        {% if user_is_producer %}
            <div class="modal hide fade" id="claim-commercial-product-modal">
                <div class="modal-header">
                    <a class="close" data-dismiss="modal">&times;</a>
                    <h3>{% trans "Claim commercial product" %}</h3>
                </div>
                <div class="modal-body">
                    <form id="claim-commercial-product" class="form-horizontal" action="{% url 'commercial_products_claim' 0 %}" method="post">{% csrf_token %}
                        <div class="form-content">
                            {{claim_commercial_gear_form|as_bootstrap}}
                        </div>
                        <div class="form-actions">
                            <input type="submit" class="btn btn-primary" value="{% trans "Claim" %}"/>
                        </div>
                    </form>
                </div>
            </div>

            <div class="modal hide fade" id="remove-commercial-products-modal">
                <div class="modal-header">
                    <a class="close" data-dismiss="modal">&times;</a>
                    <h3>{% trans "Select items to remove" %}</h3>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        {% blocktrans %}Be careful if you try to remove all of these!{% endblocktrans %}
                        {% blocktrans %}All the properties, including the commercial description, of this claim will be deleted and cannot be recovered!{% endblocktrans %}
                    </div>
                    <form id="remove-commercial-product" class="form-inline">
                        <div class="form-content">
                            <div class="loading"><img src="{% static 'astrobin/images/loading-bar.gif' %}" alt=""/></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <a href="#" class="btn" data-dismiss="modal">Cancel</a>
                    <a href="#" class="remove btn btn-primary">{% trans "Remove" %}</a>
                </div>
            </div>

            <div class="modal hide fade" id="merge-commercial-products-modal">
                <div class="modal-header">
                    <a class="close" data-dismiss="modal">&times;</a>
                    <h3>{% trans "Select the product you want to merge to" %}</h3>
                </div>
                <div class="modal-body">
                    <form id="merge-commercial-product" class="form-horizontal">
                        <div class="form-content">
                            {{merge_commercial_gear_form|as_bootstrap}}
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <a href="#" class="btn" data-dismiss="modal">Cancel</a>
                    <a href="#" class="merge btn btn-primary">{% trans "Merge" %}</a>
                </div>
            </div>

            <div class="modal hide fade" id="remove-commercial-products-confirmation-modal">
                <div class="modal-header">
                    <a class="close" data-dismiss="modal">&times;</a>
                    <h3>{% trans "Are you sure?" %}</h3>
                </div>
                <div class="modal-body">
                    {% blocktrans %}All the properties, including the commercial description, of this claim will be deleted and cannot be recovered!{% endblocktrans %}
                    <strong>{% blocktrans %}Are you sure?{% endblocktrans %}</strong>
                </div>
                <div class="modal-footer">
                    <a href="#" class="btn" data-dismiss="modal">Cancel</a>
                    <a href="#" class="btn btn-primary">Continue</a>
                </div>
            </div>
        {% endif %} <!-- user_is_producer -->

        {% if user_is_retailer %}
            <div class="modal hide fade" id="claim-retailed-product-modal">
                <div class="modal-header">
                    <a class="close" data-dismiss="modal">&times;</a>
                    <h3>{% trans "Claim retailed product" %}</h3>
                </div>
                <div class="modal-body">
                    <form id="claim-retailed-product" class="form-horizontal" action="{% url 'commercial_products_claim' 0 %}" method="post">{% csrf_token %}
                        <div class="form-content">
                            {{claim_retailed_gear_form|as_bootstrap}}
                        </div>
                        <div class="form-actions">
                            <input type="submit" class="btn btn-primary" value="{% trans "Claim" %}"/>
                        </div>
                    </form>
                </div>
            </div>

            <div class="modal hide fade" id="remove-retailed-products-modal">
                <div class="modal-header">
                    <a class="close" data-dismiss="modal">&times;</a>
                    <h3>{% trans "Select items to remove" %}</h3>
                </div>
                <div class="modal-body">
                    <form id="remove-retailed-product" class="form-inline">
                        <div class="form-content">
                            <div class="loading"><img src="{% static 'astrobin/images/loading-bar.gif' %}" alt=""/></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <a href="#" class="btn" data-dismiss="modal">Cancel</a>
                    <a href="#" class="remove btn btn-primary">{% trans "Remove" %}</a>
                </div>
            </div>

            <div class="modal hide fade" id="merge-retailed-products-modal">
                <div class="modal-header">
                    <a class="close" data-dismiss="modal">&times;</a>
                    <h3>{% trans "Select the product you want to merge to" %}</h3>
                </div>
                <div class="modal-body">
                    <form id="merge-retailed-product" class="form-horizontal">
                        <div class="form-content">
                            {{merge_retailed_gear_form|as_bootstrap}}
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <a href="#" class="btn" data-dismiss="modal">Cancel</a>
                    <a href="#" class="merge btn btn-primary">{% trans "Merge" %}</a>
                </div>
            </div>

            <div class="modal hide fade" id="remove-retailed-products-confirmation-modal">
                <div class="modal-header">
                    <a class="close" data-dismiss="modal">&times;</a>
                    <h3>{% trans "Are you sure?" %}</h3>
                </div>
                <div class="modal-body">
                    {% blocktrans %}All the properties of this claim will be deleted and cannot be recovered!{% endblocktrans %}
                    <strong>{% blocktrans %}Are you sure?{% endblocktrans %}</strong>
                </div>
                <div class="modal-footer">
                    <a href="#" class="btn" data-dismiss="modal">Cancel</a>
                    <a href="#" class="btn btn-primary">Continue</a>
                </div>
            </div>
        {% endif %} <!-- user_is_retailer -->
    {% endblock %}
{% endifequal %} <!-- user == request.user -->

{% block extra_js %}
    {% include 'user/profile/js.html' %}

    <script type="text/javascript">
        astrobin_common.setup_gear_popovers();
    </script>

    {% ifequal user request.user %}
        {% if user_is_producer %}
            <script type="text/javascript">
                $(document).ready(function() {
                    var $form = $('form#claim-commercial-product'),
                        $makes = undefined,
                        $names = undefined,
                        $merge_with = undefined,
                        $merge_with_later = undefined,
                        $btn = undefined;

                    $merge_with_later = $('form#merge-commercial-product select[name=merge_with]');

                    var reset_form_vars = function() {
                        $makes = $form.find('select[name=make]');
                        $names = $form.find('select[name=name]');
                        $merge_with = $form.find('select[name=merge_with]');
                        $btn = $form.find('input[type=submit]');
                    }

                    var reset_form_btn = function() {
                        $btn.removeClass('disabled');
                        $btn.val("{% trans "Claim" %}");
                    }

                    var disable_form_btn = function() {
                        $btn.addClass('disabled');
                        $btn.val("{% trans "Please wait..." %}");
                    }

                    var on_makes_changed = function() {
                        var make = $.trim($(this).val());
                        if (make != '') {
                            $.ajax({
                                url: '/gear/by-make/' + make + '/?unclaimed=true',
                                dataType: 'json',
                                timeout: 10000,
                                cache: false,
                                success: function(data, status, request) {
                                    $names.find('option').remove();

                                    $.each(data.gear, function(index, value) {
                                        var $opt = $('<option/>');
                                        $opt.attr('value', value.id);
                                        $opt.text(value.name);
                                        $names.append($opt);
                                    });

                                    var id = $names.find('option:first').val();
                                    $form.attr('action', '/commercial/products/claim/' + id  + '/');
                                }
                            });
                        }
                    }

                    var on_names_changed = function() {
                        var id = $(this).val();
                        $form.attr('action', '/commercial/products/claim/' + id + '/');
                    }

                    var ajaxFormOptions = {
                        dataType: 'json',
                        timeout: 10000,
                        beforeSubmit: function(formData, $form, options) {
                            disable_form_btn();
                        },
                        success: function(response) {
                            reset_form_vars();
                            if (response.success) {
                                $('#claim-commercial-product-modal').modal('hide');

                                if (response.is_merge) {
                                    $('tr[data-id=' + response.id + '] td.gear-ids').html(response.gear_ids_links);
                                    $('tr[data-id=' + response.id + '] td.gear-ids').attr('data-gear-ids', response.gear_ids);
                                } else {
                                    var $table = $('table.commercial-gear-items');
                                    var $row = $('<tr/>');

                                    $table.find('tr.empty').remove();

                                    $row.attr('data-id', response.id);
                                    $row.append('<td class="gear-ids" data-gear-ids="' + response.gear_ids + '">' + response.gear_ids_links + '</td>');
                                    $row.append('<td>' + response.make + '</td>');
                                    $row.append('<td>' + response.name + '</td>');
                                    $row.append('<td>' + response.owners + '</td>');
                                    $row.append('<td>' + response.images + '</td>');

                                    $row.append('\
                                    <td>\
                                        <a rel="tooltip" title="{% trans "View" %}" href="/gear/' + response.gear_ids + '">\
                                            <i class="icon-eye-open"></i>\
                                        </a>\
                                        <a rel="tooltip" title="{% trans "Edit" %}" href="/commercial/products/edit/' + response.id + '">\
                                            <i class="icon-edit"></i>\
                                        </a>\
                                        <a class="item-merge" rel="tooltip" title="{% trans "Merge" %}" href="#">\
                                            <i class="icon-resize-small"></i>\
                                        </a>\
                                        <a class="item-remove" rel="tooltip" title="{% trans "Remove" %}" href="#">\
                                            <i class="icon-remove"></i>\
                                        </a>\
                                    </td>');

                                    $table.append($row);

                                    // Add this to the merge_with fields.
                                    $merge_with.append($('<option/>')
                                        .val(response.id)
                                        .text(response.name)
                                    );

                                    $merge_with_later.append($('<option/>')
                                        .val(response.id)
                                        .text(response.name)
                                    );
                                }
                            } else {
                                $form.find('.form-content').html(response.form);
                                reset_form_vars();
                                on_makes_changed.apply($makes);
                                $makes.change(on_makes_changed);
                                $names.change(on_names_changed);
                            }

                            reset_form_btn();
                        },
                        error: function(response, statusText, xhr) {
                            reset_form_vars();
                            $makes.change(on_makes_changed);
                            $names.change(on_names_changed);
                            $form.find('.form-content').html(response.form);
                            reset_form_btn();
                        }
                    };

                    reset_form_vars();
                    $form.ajaxForm(ajaxFormOptions);
                    $makes.change(on_makes_changed);
                    $names.change(on_names_changed);

                    $('#claim-commercial-product-modal').on('show', function() {
                        $makes.val($makes.find('option:first').val());
                        $names.find('option').remove();

                        var $opt = $('<option/>');
                        $opt.attr('value', '');
                        $opt.text('---------');
                        $names.append($opt);

                        $merge_with.val(0);

                        $form.attr('action', '{% url 'commercial_products_claim' 0 %}');

                        $form.find('.control-group.error').removeClass('error');
                        $form.find('.help-block.error').remove();
                        $form.find('.alert-error').remove();
                        reset_form_btn();
                    });

                    $('#merge-commercial-products-modal').on('show', function() {
                        $merge_with_later.val(0);
                    });

                    $('#remove-commercial-products-modal').find('a.remove').click(function() {
                        $('#remove-commercial-products-modal').find('form').submit();
                        return false;
                    });

                    $('#remove-commercial-products-modal').find('form').submit(function() {
                        var promises = [];
                        var $modal = $(this).closest('.modal');

                        $(this).find('input:checkbox:checked').each(function() {
                            promises.push(
                                $.ajax({
                                    url: '/commercial/products/unclaim/' + $(this).val() + '/',
                                    dataType: 'json',
                                    timeout: 10000,
                                    cache: false
                                }));
                        });

                        $.when.apply($, promises).done(function(result) {
                            var l = arguments.length,
                                response;

                            if (promises.length === 1) {
                                response = $.parseJSON(arguments[2].responseText);
                            } else {
                                // We only care about the last one.
                                response = $.parseJSON(arguments[l - 1][2].responseText);
                            }

                            $table_row = $('tr[data-id=' + response.commercial_id + ']');
                            if (response.commercial_was_removed) {
                                $table_row.remove();
                                $merge_with.find('option[value=' + response.commercial_id + ']').remove();
                                $merge_with_later.find('option[value=' + response.commercial_id + ']').remove();
                            } else {
                                $table_row.find('td.gear-ids').html(response.claimed_gear_ids_links);
                                $table_row.find('td.gear-ids').attr('data-gear-ids', response.claimed_gear_ids);
                            }

                            $modal.modal('hide');
                        });

                        return false;
                    });

                    $('.item-remove').live('click', function() {
                        var $link = $(this);
                        var $table_row = $(this).closest('tr');
                        var ids = $table_row.find('td.gear-ids').attr('data-gear-ids');
                        var id_list = ids.split(',');

                        if (id_list.length == 1) {
                            var $modal = $('#remove-commercial-products-confirmation-modal');
                            $modal.find('a.btn-primary').one('click', function() {
                                $.ajax({
                                    url: '/commercial/products/unclaim/' + id_list[0] + '/',
                                    dataType: 'json',
                                    timeout: 10000,
                                    cache: false,
                                    success: function(data, status, request) {
                                        $table_row.find('a[rel=tooltip]').tooltip('hide');
                                        $table_row.remove();
                                        $merge_with.find('option[value=' + data.commercial_id + ']').remove();
                                        $merge_with_later.find('option[value=' + data.commercial_id + ']').remove();
                                        $modal.modal('hide');
                                    }
                                });

                                return false;
                            });
                            $modal.modal('show');
                         } else {
                            var $modal = $('#remove-commercial-products-modal');
                            var $form_content = $modal.find('.form-content');
                            $modal.modal('show');

                            $.ajax({
                                url: '/gear/by-ids/' + ids + '/',
                                dataType: 'json',
                                timeout: 10000,
                                cache: false,
                                success: function(data, status, request) {
                                    $form_content.html('');
                                    for (var i = 0; i < data.length; i++) {
                                        var $template = $('\
                                            <div class="control-group">\
                                                <div class="controls">\
                                                    <label class="checkbox">\
                                                        <input type="checkbox" />' + '(' + data[i][0] + ') ' + data[i][1] + ' ' + data[i][2] + '\
                                                    </label>\
                                                </div>\
                                            </div>');

                                        var $input = $template.find('input');
                                        $input
                                            .attr('id', 'id_remove_' + data[i][0])
                                            .attr('name', 'remove_' + data[i][0])
                                            .val(data[i][0]);

                                        $form_content.append($template);
                                        $input.uniform();
                                    }
                                }
                            });
                         }

                         return false;
                    });

                    $('.item-merge').live('click', function() {
                        var $modal = $('#merge-commercial-products-modal');
                        $modal.data('from_id', $(this).closest('tr').attr('data-id'));

                        $modal.modal('show');
                        return false;
                    });


                    $('#merge-commercial-products-modal').find('a.merge').click(function() {
                        $('#merge-commercial-products-modal').find('form').submit();
                    });

                    $('#merge-commercial-products-modal').on('show', function() {
                        $(this).find('.alert').remove();
                    });

                    $('#merge-commercial-products-modal').find('form').submit(function() {
                        var from_id = $(this).closest('.modal').data('from_id'),
                            to_id = $(this).find('select option:selected').val(),
                            $modal = $('#merge-commercial-products-modal');

                        $.ajax({
                            url: '/commercial/products/merge/' + from_id + '/' + to_id + '/',
                            dataType: 'json',
                            timeout: 10000,
                            cache: false,
                            success: function(response, status, request) {
                                if (response.success) {
                                    $('tr[data-id=' + from_id + ']').remove();
                                    $merge_with.find('option[value=' + from_id + ']').remove();
                                    $merge_with_later.find('option[value=' + from_id + ']').remove();

                                    var $gear_ids_td = $('tr[data-id=' + to_id + '] td.gear-ids');
                                    $gear_ids_td.html(response.claimed_gear_ids_links);
                                    $gear_ids_td.attr('data-gear-ids', response.claimed_gear_ids);

                                    $modal.modal('hide');
                                } else {
                                    $modal.find('.form-content .alert').remove();
                                    $modal.find('.form-content').prepend('\
                                        <div class="alert alert-block alert-error">\
                                            <p>' + response.message + '<p>\
                                        </div>\
                                    ');
                                }
                            }
                        });

                        return false;
                    });
                });
            </script>
        {% endif %} <!-- user_is_producer -->

        {% if user_is_retailer %}
            <script type="text/javascript">
                $(document).ready(function() {
                    var $rform = $('form#claim-retailed-product'),
                        $makes = undefined,
                        $rnames = undefined,
                        $rmerge_with = undefined,
                        $rmerge_with_later = undefined,
                        $rbtn = undefined;

                    $rmerge_with_later = $('form#merge-retailed-product select[name=merge_with]');

                    var reset_rform_vars = function() {
                        $rmakes = $rform.find('select[name=make]');
                        $rnames = $rform.find('select[name=name]');
                        $rmerge_with = $rform.find('select[name=merge_with]');
                        $rbtn = $rform.find('input[type=submit]');
                    }

                    var reset_rform_btn = function() {
                        $rbtn.removeClass('disabled');
                        $rbtn.val("{% trans "Claim" %}");
                    }

                    var disable_rform_btn = function() {
                        $rbtn.addClass('disabled');
                        $rbtn.val("{% trans "Please wait..." %}");
                    }

                    var on_rmakes_changed = function() {
                        var make = $.trim($(this).val());
                        if (make != '') {
                            $.ajax({
                                url: '/gear/by-make/' + make + '/?unclaimed=false',
                                dataType: 'json',
                                timeout: 10000,
                                cache: false,
                                success: function(data, status, request) {
                                    $rnames.find('option').remove();

                                    $.each(data.gear, function(index, value) {
                                        var $opt = $('<option/>');
                                        $opt.attr('value', value.id);
                                        $opt.text(value.name);
                                        $rnames.append($opt);
                                    });

                                    var id = $rnames.find('option:first').val();
                                    $rform.attr('action', '/commercial/products/retailed/claim/' + id  + '/');
                                }
                            });
                        }
                    }

                    var on_rnames_changed = function() {
                        var id = $(this).val();
                        $rform.attr('action', '/commercial/products/retailed/claim/' + id + '/');
                    }

                    var ajaxRFormOptions = {
                        dataType: 'json',
                        timeout: 10000,
                        beforeSubmit: function(formData, $rform, options) {
                            disable_rform_btn();
                        },
                        success: function(response) {
                            reset_rform_vars();
                            if (response.success) {
                                $('#claim-retailed-product-modal').modal('hide');

                                if (response.is_merge) {
                                    $('tr[data-id=' + response.id + '] td.gear-ids').html(response.gear_ids_links);
                                    $('tr[data-id=' + response.id + '] td.gear-ids').attr('data-gear-ids', response.gear_ids);
                                } else {
                                    var $table = $('table.retailed-gear-items');
                                    var $row = $('<tr/>');

                                    $table.find('tr.empty').remove();

                                    $row.attr('data-id', response.id);
                                    $row.append('<td class="gear-ids" data-gear-ids="' + response.gear_ids + '">' + response.gear_ids_links + '</td>');
                                    $row.append('<td>' + response.make + '</td>');
                                    $row.append('<td>' + response.name + '</td>');
                                    $row.append('<td>' + response.owners + '</td>');
                                    $row.append('<td>' + response.images + '</td>');

                                    $row.append('\
                                    <td>\
                                        <a rel="tooltip" title="{% trans "View" %}" href="/gear/' + response.gear_ids + '">\
                                            <i class="icon-eye-open"></i>\
                                        </a>\
                                        <a rel="tooltip" title="{% trans "Edit" %}" href="/commercial/products/retailed/edit/' + response.id + '">\
                                            <i class="icon-edit"></i>\
                                        </a>\
                                        <a class="retailed-item-merge" rel="tooltip" title="{% trans "Merge" %}" href="#">\
                                            <i class="icon-resize-small"></i>\
                                        </a>\
                                        <a class="retailed-item-remove" rel="tooltip" title="{% trans "Remove" %}" href="#">\
                                            <i class="icon-remove"></i>\
                                        </a>\
                                    </td>');

                                    $table.append($row);

                                    // Add this to the merge_with fields.
                                    $rmerge_with.append($('<option/>')
                                        .val(response.id)
                                        .text(response.name)
                                    );

                                    $rmerge_with_later.append($('<option/>')
                                        .val(response.id)
                                        .text(response.name)
                                    );
                                }
                            } else {
                                $rform.find('.form-content').html(response.form);
                                reset_rform_vars();
                                on_rmakes_changed.apply($rmakes);
                                $rmakes.change(on_rmakes_changed);
                                $rnames.change(on_rnames_changed);
                            }

                            reset_rform_btn();
                        },
                        error: function(response, statusText, xhr) {
                            reset_rform_vars();
                            $rmakes.change(on_rmakes_changed);
                            $rnames.change(on_rnames_changed);
                            $rform.find('.form-content').html(response.form);
                            reset_rform_btn();
                        }
                    };

                    reset_rform_vars();
                    $rform.ajaxForm(ajaxRFormOptions);
                    $rmakes.change(on_rmakes_changed);
                    $rnames.change(on_rnames_changed);

                    $('#claim-retailed-product-modal').on('show', function() {
                        $rmakes.val($rmakes.find('option:first').val());
                        $rnames.find('option').remove();

                        var $opt = $('<option/>');
                        $opt.attr('value', '');
                        $opt.text('---------');
                        $rnames.append($opt);

                        $rmerge_with.val(0);

                        $rform.attr('action', '{% url 'retailed_products_claim' 0 %}');

                        $rform.find('.control-group.error').removeClass('error');
                        $rform.find('.help-block.error').remove();
                        $rform.find('.alert-error').remove();
                        reset_rform_btn();
                    });

                    $('#merge-retailed-products-modal').on('show', function() {
                        $rmerge_with_later.val(0);
                    });

                    $('#remove-retailed-products-modal').find('a.remove').click(function() {
                        $('#remove-retailed-products-modal').find('form').submit();
                        return false;
                    });

                    $('#remove-retailed-products-modal').find('form').submit(function() {
                        var promises = [];
                        var $modal = $(this).closest('.modal');

                        $(this).find('input:checkbox:checked').each(function() {
                            promises.push(
                                $.ajax({
                                    url: '/commercial/products/retailed/unclaim/' + $(this).val() + '/',
                                    dataType: 'json',
                                    timeout: 10000,
                                    cache: false
                                }));
                        });

                        $.when.apply($, promises).done(function(result) {
                            var l = arguments.length,
                                response;

                            if (promises.length === 1) {
                                response = $.parseJSON(arguments[2].responseText);
                            } else {
                                // We only care about the last one.
                                response = $.parseJSON(arguments[l - 1][2].responseText);
                            }

                            $table_row = $('tr[data-id=' + response.retailed_id + ']');
                            if (response.commercial_was_removed) {
                                $table_row.remove();
                                $rmerge_with.find('option[value=' + response.retailed_id + ']').remove();
                                $rmerge_with_later.find('option[value=' + response.retailed_id + ']').remove();
                            } else {
                                $table_row.find('td.gear-ids').html(response.claimed_gear_ids_links);
                                $table_row.find('td.gear-ids').attr('data-gear-ids', response.claimed_gear_ids);
                            }

                            $modal.modal('hide');
                        });

                        return false;
                    });

                    $('.retailed-item-remove').live('click', function() {
                        var $link = $(this);
                        var $table_row = $(this).closest('tr');
                        var ids = $table_row.find('td.gear-ids').attr('data-gear-ids');
                        var id_list = ids.split(',');

                        if (id_list.length == 1) {
                            var $modal = $('#remove-retailed-products-confirmation-modal');
                            $modal.find('a.btn-primary').one('click', function() {
                                $.ajax({
                                    url: '/commercial/products/retailed/unclaim/' + id_list[0] + '/',
                                    dataType: 'json',
                                    timeout: 10000,
                                    cache: false,
                                    success: function(data, status, request) {
                                        $table_row.find('a[rel=tooltip]').tooltip('hide');
                                        $table_row.remove();
                                        $rmerge_with.find('option[value=' + data.retailed_id + ']').remove();
                                        $rmerge_with_later.find('option[value=' + data.retailed_id + ']').remove();
                                        $modal.modal('hide');
                                    }
                                });

                                return false;
                            });
                            $modal.modal('show');
                         } else {
                            var $modal = $('#remove-retailed-products-modal');
                            var $rform_content = $modal.find('.form-content');
                            $modal.modal('show');

                            $.ajax({
                                url: '/gear/by-ids/' + ids + '/',
                                dataType: 'json',
                                timeout: 10000,
                                cache: false,
                                success: function(data, status, request) {
                                    $rform_content.html('');
                                    for (var i = 0; i < data.length; i++) {
                                        var $template = $('\
                                            <div class="control-group">\
                                                <div class="controls">\
                                                    <label class="checkbox">\
                                                        <input type="checkbox" />' + '(' + data[i][0] + ') ' + data[i][1] + ' ' + data[i][2] + '\
                                                    </label>\
                                                </div>\
                                            </div>');

                                        var $input = $template.find('input');
                                        $input
                                            .attr('id', 'id_remove_' + data[i][0])
                                            .attr('name', 'remove_' + data[i][0])
                                            .val(data[i][0]);

                                        $rform_content.append($template);
                                        $input.uniform();
                                    }
                                }
                            });
                         }

                         return false;
                    });

                    $('.retailed-item-merge').live('click', function() {
                        var $modal = $('#merge-retailed-products-modal');
                        $modal.data('from_id', $(this).closest('tr').attr('data-id'));

                        $modal.modal('show');
                        return false;
                    });


                    $('#merge-retailed-products-modal').find('a.merge').click(function() {
                        $('#merge-retailed-products-modal').find('form').submit();
                    });

                    $('#merge-retailed-products-modal').on('show', function() {
                        $(this).find('.alert').remove();
                    });

                    $('#merge-retailed-products-modal').find('form').submit(function() {
                        var from_id = $(this).closest('.modal').data('from_id'),
                            to_id = $(this).find('select option:selected').val(),
                            $modal = $('#merge-retailed-products-modal');

                        $.ajax({
                            url: '/commercial/products/retailed/merge/' + from_id + '/' + to_id + '/',
                            dataType: 'json',
                            timeout: 10000,
                            cache: false,
                            success: function(response, status, request) {
                                if(response.success) {
                                    $('tr[data-id=' + from_id + ']').remove();
                                    $rmerge_with.find('option[value=' + from_id + ']').remove();
                                    $rmerge_with_later.find('option[value=' + from_id + ']').remove();

                                    var $gear_ids_td = $('tr[data-id=' + to_id + '] td.gear-ids');
                                    $gear_ids_td.html(response.claimed_gear_ids_links);
                                    $gear_ids_td.attr('data-gear-ids', response.claimed_gear_ids);
                                    $modal.modal('hide');
                                } else {
                                    $modal.find('.form-content .alert').remove();
                                    $modal.find('.form-content').prepend('\
                                        <div class="alert alert-block alert-error">\
                                            <p>' + response.message + '<p>\
                                        </div>\
                                    ');
                                }
                            }
                        });

                        return false;
                    });
                });
            </script>
        {% endif %} <!-- user_is_producer -->
    {% endifequal %} <!-- user == request.user -->
{% endblock %}
