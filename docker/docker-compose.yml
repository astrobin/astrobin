version: '2'

services:
  memcached:
    container_name: memcached
    image: memcached:alpine
    restart: always

  postgres:
    container_name: postgres
    image: postgres:alpine
    restart: always
    environment:
      - POSTGRES_DB=astrobin
      - POSTGRES_USER=astrobin
      - POSTGRES_PASSWORD=astrobin
    volumes:
      - postgres-data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  rabbitmq:
    container_name: rabbitmq
    image: rabbitmq:management-alpine
    restart: always 
    environment:
      - RABBITMQ_DEFAULT_USER=astrobin
      - RABBITMQ_DEFAULT_PASS=astrobin
    ports:
      - "5672:5672"
      - "15672:15672"

  nginx:
    container_name: nginx
    build:
      context: ../
      args:
        - ENV=local
      dockerfile: docker/nginx.dockerfile
    restart: always
    depends_on:
      - astrobin
    links:
      - astrobin
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - media:/media
      - letsencrypt:/etc/letsencrypt

  elasticsearch:
    container_name: elasticsearch
    image: elasticsearch:2.4.6-alpine
    restart: always
    ports:
      - "9200:9200"

  celery_default:
    container_name: celery_default
    build:
      context: ../
      dockerfile: docker/astrobin.dockerfile
    command: celery worker -A astrobin -Q default,email -c 8 -l debug -f celery_default.log
    restart: always
    depends_on:
      - memcached
      - postgres
      - rabbitmq
      - elasticsearch
    links:
      - memcached
      - postgres
      - rabbitmq
      - elasticsearch
    env_file:
      - ./astrobin.env
    environment:
      - C_FORCE_ROOT=true
      - PYTHONPATH=/usr/lib/python2.7/dist-packages
      - DJANGO_SETTINGS_MODULE=astrobin.settings
      - CELERY_RDB_HOST=0.0.0.0
      - CELERY_RDB_PORT=6900
      - POSTGRES_DB=astrobin
      - POSTGRES_USER=astrobin
      - POSTGRES_PASSWORD=astrobin
    volumes:
      - ..:/code
      - media:/media
    ports:
      - "6900-6910:6900-6910" # Debug port

  celery_thumbnails:
    container_name: celery_thumbnails
    build:
      context: ../
      dockerfile: docker/astrobin.dockerfile
    command: celery worker -A astrobin -Q thumbnails -c 8 -l debug -f celery_thumbnails.log
    restart: always
    depends_on:
      - memcached
      - postgres
      - rabbitmq
      - elasticsearch
    links:
      - memcached
      - postgres
      - rabbitmq
      - elasticsearch
    env_file:
      - ./astrobin.env
    environment:
      - C_FORCE_ROOT=true
      - PYTHONPATH=/usr/lib/python2.7/dist-packages
      - DJANGO_SETTINGS_MODULE=astrobin.settings
      - CELERY_RDB_HOST=0.0.0.0
      - CELERY_RDB_PORT=6900
      - POSTGRES_DB=astrobin
      - POSTGRES_USER=astrobin
      - POSTGRES_PASSWORD=astrobin
    volumes:
      - ..:/code
      - media:/media

  celery_haystack:
    container_name: celery_haystack
    build:
      context: ../
      dockerfile: docker/astrobin.dockerfile
    command: celery worker -A astrobin -Q haystack -c 8 -l debug -f celery_haystack.log
    restart: always
    depends_on:
      - memcached
      - postgres
      - rabbitmq
      - elasticsearch
    links:
      - memcached
      - postgres
      - rabbitmq
      - elasticsearch
    env_file:
      - ./astrobin.env
    environment:
      - C_FORCE_ROOT=true
      - PYTHONPATH=/usr/lib/python2.7/dist-packages
      - DJANGO_SETTINGS_MODULE=astrobin.settings
      - CELERY_RDB_HOST=0.0.0.0
      - CELERY_RDB_PORT=6900
      - POSTGRES_DB=astrobin
      - POSTGRES_USER=astrobin
      - POSTGRES_PASSWORD=astrobin
    volumes:
      - ..:/code
      - media:/media

  beat:
    container_name: beat
    build:
      context: ../
      dockerfile: docker/astrobin.dockerfile
    command: celery -A astrobin beat -l info --scheduler django_celery_beat.schedulers:DatabaseScheduler
    depends_on:
      - memcached
      - postgres
      - rabbitmq
      - elasticsearch
    links:
      - memcached
      - postgres
      - rabbitmq
      - elasticsearch
    env_file:
      - ./astrobin.env
    environment:
      - C_FORCE_ROOT=true
      - PYTHONPATH=/usr/lib/python2.7/dist-packages
      - DJANGO_SETTINGS_MODULE=astrobin.settings
      - CELERY_RDB_HOST=0.0.0.0
      - CELERY_RDB_PORT=6900
      - POSTGRES_DB=astrobin
      - POSTGRES_USER=astrobin
      - POSTGRES_PASSWORD=astrobin
    volumes:
      - ..:/code
    restart: on-failure

  astrobin:
    container_name: astrobin
    restart: always
    build:
      context: ../
      dockerfile: docker/astrobin.dockerfile
    command: gunicorn wsgi:application -w 4 -b :8083
    depends_on:
      - memcached
      - postgres
      - rabbitmq
      - elasticsearch
      - wdb
    links:
      - memcached
      - postgres
      - rabbitmq
      - elasticsearch
      - wdb
    env_file:
      - ./astrobin.env
    environment:
      - PYTHONPATH=/usr/lib/python2.7/dist-packages
      - DJANGO_SETTINGS_MODULE=astrobin.settings
      - WDB_SOCKET_SERVER=wdb
      - WDB_NO_BROWSER_AUTO_OPEN=True
      - POSTGRES_DB=astrobin
      - POSTGRES_USER=astrobin
      - POSTGRES_PASSWORD=astrobin
      - CODECOV_TOKEN
    volumes:
      - ..:/code
      - media:/media
    ports:
      - "8083:8083"
      - "8084:8084" # Debugging purposes

  wdb:
    image: kozea/wdb-server
    container_name: wdb
    ports:
      - "1984:1984"


  flower:
    container_name: flower
    image: totem/celery-flower-docker
    restart: always
    depends_on:
      - rabbitmq
      - celery_default
      - celery_thumbnails
      - celery_haystack
    links:
      - rabbitmq
    env_file:
      - ./astrobin.env
    environment:
      - AMQP_HOST=rabbitmq
      - AMQP_USERNAME=astrobin
      - AMQP_PASSWORD=astrobin
      - AMQP_ADMIN_HOST=rabbitmq
      - AMQP_ADMIN_USERNAME=astrobin
      - AMQP_ADMIN_PASSWORD=astrobin
    ports:
      - "5555:5555"

volumes:
  postgres-data: {}
  media: {}
  letsencrypt: {}
